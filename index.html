<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>استمارة المعلومات للمسابقات - نسخة PDF كاملة</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f1f5f9; }
        .form-section { background: white; border-radius: 1rem; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
        .section-header { background-color: #1e293b; color: white; padding: 0.5rem 1rem; border-radius: 0.4rem; font-weight: 800; margin-bottom: 1.5rem; display: inline-block; }
        input, select, textarea { border: 2px solid #cbd5e1; padding: 0.7rem; border-radius: 0.5rem; width: 100%; margin-top: 0.3rem; font-weight: 600; }
        .label-title { font-weight: 700; color: #475569; font-size: 0.85rem; }
        
        /* تنسيق الـ PDF المخفي ليظهر بشكل رسمي */
        #pdf-export-container {
            position: absolute; left: -9999px; top: 0;
            width: 210mm; /* A4 Width */
            padding: 15mm;
            background: white;
            color: black;
            direction: rtl;
        }
        .pdf-header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px; }
        .pdf-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        .pdf-table th, .pdf-table td { border: 1px solid #000; padding: 6px; font-size: 11pt; text-align: right; }
        .pdf-table th { background-color: #f3f4f6; width: 30%; }
        .pdf-section-title { background: #e5e7eb; padding: 5px; font-weight: bold; margin-top: 10px; border: 1px solid #000; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef } = React;

        const wilayas = ["01- أدرار", "02- الشلف", "03- الأغواط", "04- أم البواقي", "05- باتنة", "06- بجاية", "07- بسكرة", "08- بشار", "09- البليدة", "10- البويرة", "11- تمنراست", "12- تبسة", "13- تلمسان", "14- تيارت", "15- تيزي وزو", "16- الجزائر", "17- الجلفة", "18- جيجل", "19- سطيف", "20- سعيدة", "21- سكيكدة", "22- سيدي بلعباس", "23- عنابة", "24- قالمة", "25- قسنطينة", "26- المدية", "27- مستغانم", "28- المسيلة", "29- معسكر", "30- ورقلة", "31- وهران", "32- البيض", "33- إليزي", "34- برج بوعريريج", "35- بومرداس", "36- الطارف", "37- تندوف", "38- تسمسيلت", "39- الوادي", "40- خنشلة", "41- سوق أهراس", "42- تيبازة", "43- ميلة", "44- عين الدفلى", "45- النعامة", "46- عين تموشنت", "47- غرداية", "48- غليزان", "49- تيميمون", "50- برج باجي مختار", "51- أولاد جلال", "52- بني عباس", "53- عين صالح", "54- عين قزام", "55- تقرت", "56- جانت", "57- المغير", "58- المنيعة"];

        const App = () => {
            const [step, setStep] = useState(1);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [submitted, setSubmitted] = useState(false);
            const pdfRef = useRef(null);

            const [formData, setFormData] = useState({
                directorate: '', requestedRank: '', teachingSubject: '',
                nin: '', lastNameAr: '', firstNameAr: '', lastNameLat: '', firstNameLat: '',
                fatherName: '', motherFirstName: '', motherLastName: '', birthDate: '',
                birthWilaya: '', birthCommune: '', gender: 'ذكر',
                maritalStatus: 'أعزب / عزباء', childrenCount: '0', 
                fullAddress: '', phoneNumber: '', email: '',
                militaryStatus: 'معفى', docRefNum: '',
                degreeName: '', specialty: '', graduationDate: '', issuingInstitution: '', degreeGrade: '',
                semesters: Array(5).fill({ s1: '', s2: '', annual: '' }),
                expJob: '', expInstitution: '', expFrom: '', expTo: '',
                isEmployed: 'لا', currentRank: ''
            });

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSemesterChange = (index, field, value) => {
                const newSemesters = [...formData.semesters];
                newSemesters[index] = { ...newSemesters[index], [field]: value };
                setFormData(prev => ({ ...prev, semesters: newSemesters }));
            };

            const generateAndSendPDF = async (e) => {
                e.preventDefault();
                setIsSubmitting(true);

                try {
                    const element = pdfRef.current;
                    const canvas = await html2canvas(element, { scale: 2, useCORS: true });
                    const imgData = canvas.toDataURL('image/jpeg', 0.95);
                    
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                    
                    pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
                    
                    // تحميل الملف للمستخدم أولاً
                    pdf.save(`استمارة_${formData.firstNameAr}_${formData.lastNameAr}.pdf`);

                    // إرسال عبر البريد
                    const pdfBlob = pdf.output('blob');
                    const mailData = new FormData();
                    mailData.append("NIN", formData.nin);
                    mailData.append("Full_Name", `${formData.firstNameAr} ${formData.lastNameAr}`);
                    mailData.append("PDF_File", new File([pdfBlob], "form.pdf", { type: "application/pdf" }));
                    mailData.append("_subject", `طلب مشاركة جديد: ${formData.firstNameAr}`);
                    mailData.append("_captcha", "false");

                    await fetch("https://formsubmit.co/ajax/ksarinfo.impr@gmail.com", {
                        method: "POST",
                        body: mailData
                    });

                    setSubmitted(true);
                } catch (err) {
                    console.error(err);
                    alert("حدث خطأ أثناء إنشاء الملف.");
                } finally {
                    setIsSubmitting(false);
                }
            };

            if (submitted) return (
                <div className="min-h-screen flex items-center justify-center p-6 text-center">
                    <div className="bg-white p-10 rounded-2xl shadow-2xl max-w-lg w-full">
                        <div className="text-green-600 text-6xl mb-4">✓</div>
                        <h2 className="text-2xl font-black mb-2">تم إنشاء الملف وإرساله!</h2>
                        <p className="text-gray-600 mb-8">لقد تم تحميل نسخة PDF على جهازك بنجاح وإرسال نسخة للإدارة.</p>
                        <button onClick={() => window.location.reload()} className="bg-slate-800 text-white px-8 py-3 rounded-xl font-black w-full">تقديم طلب آخر</button>
                    </div>
                </div>
            );

            return (
                <div className="max-w-4xl mx-auto py-10 px-4">
                    {/* القالب المخفي المخصص للـ PDF */}
                    <div id="pdf-export-container" ref={pdfRef}>
                        <div className="pdf-header">
                            <h2 style={{fontSize: '14pt', fontWeight: 'bold'}}>الجمهورية الجزائرية الديمقراطية الشعبية</h2>
                            <h3 style={{fontSize: '12pt'}}>استمارة معلومات للمشاركة في المسابقة على أساس الشهادة</h3>
                        </div>

                        <div className="pdf-section-title">1. معلومات المنصب المطلوب</div>
                        <table className="pdf-table">
                            <tbody>
                                <tr><th>الجهة المعنية</th><td>{formData.directorate}</td></tr>
                                <tr><th>الرتبة والمادة</th><td>{formData.requestedRank} - {formData.teachingSubject}</td></tr>
                            </tbody>
                        </table>

                        <div className="pdf-section-title">2. معلومات الهوية</div>
                        <table className="pdf-table">
                            <tbody>
                                <tr><th>الاسم واللقب</th><td>{formData.firstNameAr} {formData.lastNameAr}</td></tr>
                                <tr><th>رقم التعريف الوطني</th><td>{formData.nin}</td></tr>
                                <tr><th>تاريخ ومكان الميلاد</th><td>{formData.birthDate} بـ {formData.birthCommune}</td></tr>
                                <tr><th>ابن (ة)</th><td>{formData.fatherName} و {formData.motherFirstName} {formData.motherLastName}</td></tr>
                                <tr><th>الحالة العائلية</th><td>{formData.maritalStatus} (عدد الأولاد: {formData.childrenCount})</td></tr>
                                <tr><th>الوضعية تجاه الخدمة الوطنية</th><td>{formData.militaryStatus} - رقم الوثيقة: {formData.docRefNum}</td></tr>
                            </tbody>
                        </table>

                        <div className="pdf-section-title">3. الشهادات والمسار الدراسي</div>
                        <table className="pdf-table">
                            <tbody>
                                <tr><th>الشهادة والتخصص</th><td>{formData.degreeName} ({formData.specialty})</td></tr>
                                <tr><th>المؤسسة وتاريخ التخرج</th><td>{formData.issuingInstitution} ({formData.graduationDate})</td></tr>
                                <tr><th>التقدير العام</th><td>{formData.degreeGrade}</td></tr>
                            </tbody>
                        </table>

                        <table className="pdf-table text-center">
                            <thead>
                                <tr className="bg-gray-100"><th>السنة الدراسية</th><th>معدل س1</th><th>معدل س2</th><th>المعدل السنوي</th></tr>
                            </thead>
                            <tbody>
                                {formData.semesters.map((s, idx) => s.annual && (
                                    <tr key={idx}><td>السنة {idx + 1}</td><td>{s.s1}</td><td>{s.s2}</td><td>{s.annual}</td></tr>
                                ))}
                            </tbody>
                        </table>

                        <div className="pdf-section-title">4. الخبرة المهنية والوضعية الحالية</div>
                        <table className="pdf-table">
                            <tbody>
                                <tr><th>آخر وظيفة</th><td>{formData.expJob} بـ {formData.expInstitution}</td></tr>
                                <tr><th>الفترة</th><td>من: {formData.expFrom} إلى: {formData.expTo}</td></tr>
                                <tr><th>هل أنت موظف حالياً؟</th><td>{formData.isEmployed} (الرتبة الحالية: {formData.currentRank})</td></tr>
                            </tbody>
                        </table>

                        <div style={{marginTop: '30px', display: 'flex', justifyContent: 'space-between'}}>
                            <p>توقيع المترشح: ...........................</p>
                            <p>حرر بـ: ..................... بتاريخ: .....................</p>
                        </div>
                    </div>

                    {/* واجهة المستخدم */}
                    <header className="mb-8 text-center bg-white p-6 rounded-2xl shadow-sm">
                        <h1 className="text-2xl font-black text-slate-800">طلب مشاركة في المسابقة</h1>
                        <p className="text-blue-600 font-bold">يرجى ملء كافة البيانات بدقة لإنشاء ملف الـ PDF</p>
                    </header>

                    <form onSubmit={generateAndSendPDF} className="space-y-6">
                        {step === 1 && (
                            <div className="form-section">
                                <h2 className="section-header">1. معلومات المنصب</h2>
                                <div className="grid md:grid-cols-2 gap-4">
                                    <div><label className="label-title">الولاية المعنية</label>
                                        <select name="directorate" required onChange={handleChange}><option value="">اختر</option>{wilayas.map(w => <option key={w} value={w}>{w}</option>)}</select>
                                    </div>
                                    <div><label className="label-title">الرتبة</label><input type="text" name="requestedRank" placeholder="مثلا: أستاذ ثانوي" required onChange={handleChange} /></div>
                                    <div className="md:col-span-2"><label className="label-title">المادة</label><input type="text" name="teachingSubject" required onChange={handleChange} /></div>
                                </div>
                                <button type="button" onClick={() => setStep(2)} className="mt-6 bg-blue-600 text-white px-8 py-2 rounded-lg font-bold">التالي</button>
                            </div>
                        )}

                        {step === 2 && (
                            <div className="form-section">
                                <h2 className="section-header">2. المعلومات الشخصية</h2>
                                <div className="grid md:grid-cols-2 gap-4">
                                    <div className="md:col-span-2"><label className="label-title">رقم التعريف الوطني (NIN)</label><input type="text" name="nin" maxLength="18" required onChange={handleChange} /></div>
                                    <div><label className="label-title">الاسم</label><input type="text" name="firstNameAr" required onChange={handleChange} /></div>
                                    <div><label className="label-title">اللقب</label><input type="text" name="lastNameAr" required onChange={handleChange} /></div>
                                    <div><label className="label-title">تاريخ الميلاد</label><input type="date" name="birthDate" required onChange={handleChange} /></div>
                                    <div><label className="label-title">بلدية الميلاد</label><input type="text" name="birthCommune" required onChange={handleChange} /></div>
                                    <div><label className="label-title">الحالة العائلية</label>
                                        <select name="maritalStatus" onChange={handleChange}>
                                            <option>أعزب / عزباء</option>
                                            <option>متزوج(ة)</option>
                                            <option>مطلق(ة)</option>
                                        </select>
                                    </div>
                                    <div><label className="label-title">الخدمة الوطنية</label>
                                        <select name="militaryStatus" onChange={handleChange}>
                                            <option>معفى</option>
                                            <option>مؤدى</option>
                                            <option>مؤجل</option>
                                        </select>
                                    </div>
                                </div>
                                <div className="flex gap-2 mt-6">
                                    <button type="button" onClick={() => setStep(1)} className="bg-gray-400 text-white px-8 py-2 rounded-lg font-bold">السابق</button>
                                    <button type="button" onClick={() => setStep(3)} className="bg-blue-600 text-white px-8 py-2 rounded-lg font-bold">التالي</button>
                                </div>
                            </div>
                        )}

                        {step === 3 && (
                            <div className="form-section">
                                <h2 className="section-header">3. المسار الدراسي (المعدلات)</h2>
                                <div className="grid md:grid-cols-2 gap-4 mb-4">
                                    <div><label className="label-title">الشهادة</label><input type="text" name="degreeName" placeholder="ليسانس، ماستر..." required onChange={handleChange} /></div>
                                    <div><label className="label-title">التخصص</label><input type="text" name="specialty" required onChange={handleChange} /></div>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full border text-sm">
                                        <thead className="bg-gray-50"><tr><th>السنة</th><th>س1</th><th>س2</th><th>السنوي</th></tr></thead>
                                        <tbody>
                                            {[0, 1, 2, 3, 4].map(idx => (
                                                <tr key={idx}>
                                                    <td className="p-2 border font-bold">السنة {idx+1}</td>
                                                    <td className="border"><input type="text" className="w-full p-1 text-center" onChange={(e) => handleSemesterChange(idx, 's1', e.target.value)} /></td>
                                                    <td className="border"><input type="text" className="w-full p-1 text-center" onChange={(e) => handleSemesterChange(idx, 's2', e.target.value)} /></td>
                                                    <td className="border"><input type="text" className="w-full p-1 text-center bg-blue-50" onChange={(e) => handleSemesterChange(idx, 'annual', e.target.value)} /></td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                                <div className="flex gap-2 mt-6">
                                    <button type="button" onClick={() => setStep(2)} className="bg-gray-400 text-white px-8 py-2 rounded-lg font-bold">السابق</button>
                                    <button type="button" onClick={() => setStep(4)} className="bg-blue-600 text-white px-8 py-2 rounded-lg font-bold">التالي</button>
                                </div>
                            </div>
                        )}

                        {step === 4 && (
                            <div className="form-section">
                                <h2 className="section-header">4. إنهاء وإرسال</h2>
                                <div className="grid md:grid-cols-2 gap-4">
                                    <div><label className="label-title">رقم الهاتف</label><input type="text" name="phoneNumber" required onChange={handleChange} /></div>
                                    <div><label className="label-title">البريد الإلكتروني</label><input type="email" name="email" required onChange={handleChange} /></div>
                                    <div className="md:col-span-2 bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                                        <p className="text-sm font-bold text-yellow-800">عند الضغط على إرسال، سيقوم المتصفح بتحميل ملف PDF بالبيانات التي أدخلتها، وسيتم إرسال نسخة منه إلى الإدارة.</p>
                                    </div>
                                </div>
                                <div className="flex gap-2 mt-6">
                                    <button type="button" onClick={() => setStep(3)} className="bg-gray-400 text-white px-8 py-2 rounded-lg font-bold">السابق</button>
                                    <button type="submit" disabled={isSubmitting} className="bg-green-600 text-white px-10 py-2 rounded-lg font-black shadow-lg hover:bg-green-700 disabled:bg-gray-400">
                                        {isSubmitting ? "جاري المعالجة..." : "توليد PDF وإرسال الطلب"}
                                    </button>
                                </div>
                            </div>
                        )}
                    </form>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
