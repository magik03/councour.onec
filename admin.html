
<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>لوحة تحكم المسؤول المحمية</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyBdlRDPTQqY8lZvD4R7nneXAwPgRbxmm14",
        authDomain: "councour-59e43.firebaseapp.com",
        databaseURL: "https://councour-59e43-default-rtdb.firebaseio.com/", 
        projectId: "councour-59e43",
        storageBucket: "councour-59e43.firebasestorage.app",
        messagingSenderId: "492907661374",
        appId: "1:492907661374:web:31792fc3ab95d0e69ea96f"
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();
      const auth = firebase.auth();

      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['Tajawal', 'sans-serif'] },
            colors: { 'dz-green': '#008568', 'admin-blue': '#0f172a' }
          },
        },
      }
    </script>
    <style>
      .modal-overlay { background: rgba(2, 6, 23, 0.9); backdrop-filter: blur(12px); }
      .detail-card { background: #ffffff; border-radius: 1rem; padding: 1rem; border: 1px solid #e2e8f0; }
      .detail-label { font-size: 0.75rem; font-weight: 800; color: #64748b; display: block; border-bottom: 1px dashed #e2e8f0; margin-bottom: 0.25rem; }
      .detail-value { font-size: 1rem; font-weight: 900; color: #0f172a; word-break: break-all; }
      .section-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem; border-bottom: 3px solid #0f172a; padding-bottom: 0.5rem; }
    </style>
  </head>
  <body class="bg-slate-50 font-sans text-right">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;

      // --- مكون تسجيل الدخول ---
      const LoginPage = () => {
        const [email, setEmail] = useState('');
        const [password, setPassword] = useState('');
        const [error, setError] = useState('');

        const handleLogin = (e) => {
          e.preventDefault();
          auth.signInWithEmailAndPassword(email, password)
            .catch(err => setError("خطأ: البريد أو كلمة المرور غير صحيحة"));
        };

        return (
          <div className="min-h-screen flex items-center justify-center bg-admin-blue p-4">
            <form onSubmit={handleLogin} className="bg-white p-10 rounded-[2.5rem] shadow-2xl w-full max-w-md border-4 border-dz-green/20">
              <h2 className="text-3xl font-black text-center mb-8 text-admin-blue">لوحة الإدارة (د.عبد المجيد)</h2>
              {error && <p className="bg-red-50 text-red-600 p-4 rounded-xl mb-6 text-sm font-bold text-center">{error}</p>}
              <div className="space-y-5">
                <input 
                  type="email" placeholder="البريد الإلكتروني" 
                  className="w-full p-4 border-2 rounded-2xl outline-none focus:border-dz-green"
                  onChange={(e) => setEmail(e.target.value)} required 
                />
                <input 
                  type="password" placeholder="كلمة المرور" 
                  className="w-full p-4 border-2 rounded-2xl outline-none focus:border-dz-green"
                  onChange={(e) => setPassword(e.target.value)} required 
                />
                <button type="submit" className="w-full bg-dz-green text-white py-4 rounded-2xl font-black text-xl shadow-lg shadow-dz-green/30 transition-all hover:scale-105">
                  دخول آمن
                </button>
              </div>
            </form>
          </div>
        );
      };

      // --- المكون الرئيسي (لوحة التحكم) ---
      const Dashboard = () => {
        const [submissions, setSubmissions] = useState([]);
        const [selected, setSelected] = useState(null);
        const [loading, setLoading] = useState(true);

        useEffect(() => {
          const ref = db.ref('submissions');
          ref.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
              const list = Object.keys(data).map(key => ({ id: key, ...data[key] }));
              setSubmissions(list.reverse());
            } else { setSubmissions([]); }
            setLoading(false);
          });
          return () => ref.off();
        }, []);

        const updateStatus = (id, newStatus) => {
          db.ref(`submissions/${id}`).update({ status: newStatus });
          if (selected) setSelected({...selected, status: newStatus});
        };

        const deleteEntry = (id) => {
          if (confirm('هل أنت متأكد من الحذف النهائي للملف؟')) db.ref(`submissions/${id}`).remove();
        };

        const handleLogout = () => auth.signOut();

        return (
          <div className="min-h-screen flex flex-col">
            <header className="bg-admin-blue text-white p-6 shadow-2xl sticky top-0 z-50 flex justify-between items-center">
                <div className="flex items-center gap-4">
                  <h1 className="text-2xl font-black">لوحة تحكم المسؤول</h1>
                  <button onClick={handleLogout} className="text-xs bg-red-600/20 text-red-400 px-3 py-1 rounded-lg border border-red-600/30 hover:bg-red-600 hover:text-white transition-all">تسجيل خروج</button>
                </div>
                <div className="bg-dz-green px-6 py-2 rounded-full font-black">إجمالي الملفات: {submissions.length}</div>
            </header>

            <main className="max-w-7xl mx-auto w-full p-6 md:p-12">
              {loading ? (
                <div className="text-center py-20 font-black text-slate-400 text-xl">جاري جلب البيانات من السحابة...</div>
              ) : (
                <div className="bg-white rounded-[2.5rem] shadow-xl border overflow-hidden">
                  <table className="w-full text-right">
                    <thead className="bg-slate-100 border-b-2">
                      <tr>
                        <th className="px-8 py-5 font-black">المترشح</th>
                        <th className="px-8 py-5 font-black">الرتبة</th>
                        <th className="px-8 py-5 font-black text-center">الحالة</th>
                        <th className="px-8 py-5 font-black text-center">إجراءات</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100">
                      {submissions.length === 0 ? (
                        <tr><td colSpan="4" className="px-8 py-20 text-center text-slate-400 font-bold">لا توجد تسجيلات حتى الآن</td></tr>
                      ) : submissions.map(s => (
                        <tr key={s.id} className="hover:bg-slate-50 transition-colors">
                          <td className="px-8 py-6 font-black text-slate-900">{s.lastNameAr} {s.firstNameAr}</td>
                          <td className="px-8 py-6 font-bold text-slate-600 text-sm">{s.rank}</td>
                          <td className="px-8 py-6 text-center">
                            <span className={`px-4 py-1.5 rounded-full text-xs font-black border ${
                              s.status === 'مقبول' ? 'bg-green-50 text-green-700 border-green-200' : 
                              s.status === 'مرفوض' ? 'bg-red-50 text-red-700 border-red-200' : 'bg-amber-50 text-amber-800 border-amber-200'
                            }`}>{s.status || 'قيد الانتظار'}</span>
                          </td>
                          <td className="px-8 py-6 flex justify-center gap-2">
                            <button onClick={() => setSelected(s)} className="p-2.5 bg-admin-blue text-white rounded-xl shadow-md">معاينة</button>
                            <button onClick={() => deleteEntry(s.id)} className="p-2.5 bg-red-50 text-red-600 rounded-xl border border-red-100">حذف</button>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}
            </main>

            {selected && (
              <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 modal-overlay">
                <div className="bg-white rounded-[3rem] w-full max-w-5xl max-h-[90vh] overflow-y-auto p-10 relative shadow-2xl">
                  <div className="flex justify-between items-center mb-10 border-b-2 pb-6">
                    <h3 className="text-3xl font-black text-slate-900">ملف المترشح: {selected.lastNameAr}</h3>
                    <button onClick={() => setSelected(null)} className="text-5xl text-slate-300 hover:text-red-600 transition-colors">&times;</button>
                  </div>
                  
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div className="detail-card"><span className="detail-label">NIN</span><span className="detail-value">{selected.nin}</span></div>
                    <div className="detail-card"><span className="detail-label">الاسم الكامل</span><span className="detail-value">{selected.firstNameAr} {selected.lastNameAr}</span></div>
                    <div className="detail-card"><span className="detail-label">الرتبة</span><span className="detail-value">{selected.rank}</span></div>
                    <div className="detail-card"><span className="detail-label">الهاتف</span><span className="detail-value">{selected.phone}</span></div>
                    <div className="detail-card"><span className="detail-label">البريد الإلكتروني</span><span className="detail-value">{selected.email}</span></div>
                    <div className="detail-card"><span className="detail-label">تاريخ التسجيل</span><span className="detail-value">{selected.submissionDate}</span></div>
                  </div>

                  <div className="sticky bottom-0 bg-white pt-10 border-t-4 mt-12 flex flex-wrap justify-center gap-4">
                    <button onClick={() => updateStatus(selected.id, 'مقبول')} className="px-12 py-4 bg-dz-green text-white font-black rounded-2xl shadow-lg hover:scale-105 transition-all">قبول الملف</button>
                    <button onClick={() => updateStatus(selected.id, 'مرفوض')} className="px-12 py-4 bg-red-600 text-white font-black rounded-2xl shadow-lg hover:scale-105 transition-all">رفض الملف</button>
                    <button onClick={() => setSelected(null)} className="px-12 py-4 bg-slate-200 text-slate-700 font-black rounded-2xl">إغلاق</button>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      };

      const App = () => {
        const [user, setUser] = useState(null);
        const [initializing, setInitializing] = useState(true);

        useEffect(() => {
          const unsubscribe = auth.onAuthStateChanged(u => {
            setUser(u);
            setInitializing(false);
          });
          return () => unsubscribe();
        }, []);

        if (initializing) return <div className="min-h-screen bg-admin-blue flex items-center justify-center text-white font-black text-2xl">جاري التحقق...</div>;
        
        return user ? <Dashboard /> : <LoginPage />;
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
